---
title: "Mean age of first reproduction"
author: "Erin Feichtinger"
date: "Friday, April 29, 2016"
output: html_document
---


From Bruce's comments on the manuscript regarding the residences times of individuals in each stage from the fundamental matrix comes this...

### Estimating the expected age of first reproduction

I followed Caswell in Chapter 5 by first decomposing the life cycle and understanding it as a Markov chain. To estimate mean age at reproduction, it involves a new transition matrix based on the addition of another absorbing state. In this case, both death and reproduce-before-dying are absorbing states. The estimation involves several steps with matrix operations. After several frustrating hours, I finally figured out which model parameters go where in the new matrices (T'and M', see Caswell pg) for both a single type and a two phenotype model. 

I wrote functions for each step in the process. I used the orca whale data to test the functions and I get the same answer as Caswell in each step and the estimate for the mean age of first reproduction for orcas. Then, I arbitrarily chose values for each parameter in the growth model (single type) to see what number I get. Then, I repeated the process for the two type model. 

```{r, echo=FALSE}
library(popbio)
### Single type growth model
### Finding the age at first reproduction 

#s = 0.4
#g = 0.6
#F = 1
#P = 0.7
pop <- matrix(c(0.16,1,0.24,0.7),nrow=2, ncol=2, byrow=TRUE)
colnames(pop) <- c("juvenile","adult")
rownames(pop) <- c("juvenile", "adult")

#splitA
spA <- splitA(pop, r = 1, c = 2)
trans <- spA$T
iden <- matrix(c(1,0,0,1), nrow=2, ncol=2, byrow=TRUE)

Tprime <- matrix(c(0.16,0,0.24,0), nrow=2, ncol=2, byrow=TRUE)
Mprime <- matrix(c(0.6,0,0,1), nrow=2, ncol=2, byrow=TRUE)
Pprime <- matrix(c(0.16,0,0,0,0.24,0,0,0,0.6,0,1,0,0,1,0,1), nrow=4, ncol=4,byrow=TRUE)

Bprime <- Mprime %*% (solve(iden-Tprime))
b2 <- Bprime[2,1:2]

e <- matrix(c(1,1),nrow=2,ncol=1)
et <- t(e)

tc <- (solve(diag(b2))) %*% trans %*% diag(b2)
expect <- et %*% (solve(iden-tc))
expect

```

The answer for this particular combination of parameter values is an expected age of first reproduction of 1.462 years for a single type model. Now, I did the same thing for a two type model where sigma = 0.05 (and represents a standard deviation) and phi = 0. 


```{r, echo = FALSE}
# What if I did the 2 type? See what happens
#s=0.4, g = 0.6, P = 0.7, F = 1, sigma = 0.05, phi = 0

pop.mat <- matrix(c(0.18,1,0,0,0.22,0.7,0,0,0,0,0.14,1,0,0,0.26,0.7),
                  nrow = 4, ncol=4, byrow=TRUE)

colnames(pop.mat) <- c("slow juvenile","slow adult", "fast juvenile","fast adult")
rownames(pop.mat) <- c("slow juvenile","slow adult", "fast juvenile","fast adult")

#splitA
spA2 <- splitA(pop.mat, r = c(1,3), c = c(2,4))
trans2 <- spA2$T
iden2 <- matrix(c(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1), nrow=4, ncol=4, byrow=TRUE)

Tprime2 <- matrix(c(0.18,0,0,0,0.22,0,0,0,0,0,0.14,0,0,0,0.26,0),
                  nrow=4, ncol=4, byrow=TRUE)
Mprime2 <- matrix(c(0.6,0,0.6,0,0,1,0,1), nrow=2, ncol=4, byrow=TRUE)

Bprime2 <- Mprime2 %*% (solve(iden2-Tprime2))
b2.2 <- Bprime2[2,1:4]

e2 <- matrix(c(1,1,1,1),nrow=4,ncol=1)

tc2 <- solve(diag(b2.2)) %*% trans2 %*% diag(b2.2)
expect2 <- (t(e2)) %*% (solve(iden2 - tc2))
expect2
```

I'm not sure that is correct because the slow phenotype has a lower age at first reproduction (although the differnce is not large). It's close to the value for the single type model, around 1.5 years to maturity. 

I wrote the functions for adding into the simulation. That's easy enough. However, the hard part is to make sure all of the correct elements go into T', M' and B'. 

### Functions

```{r}
#This function is Eq (5.51) in Caswell, all entries all matrices
#input for m is mprime
#input for i is identity matrix 
#input for t is tprime 
bprime <- function(m,i,t){
  b <- m %*% (solve(i - t))
  return(b) 
}

#This object is the second row of Bprime, it's a row vector or 1 X 4 matrix
#b2prime <- bprime[2,1:2]


#Function computes T(c), inputs and output are matrices
#the input for b is b2prime
#the input for t is the transition matrix 
#output is a matrix, the T(c) matrix 
tc.mat <- function(b,t){
  tc <- solve(diag(b)) %*% t %*% diag(b)
  return(tc)
}


#Function computes the mean age at first reprodcuction
#input at i is the identity matrix 
#input at e is a column vector of 1's with dim 1 X s 
#input t is tc.mat 
mean.age <- function(e,i,t){
  ma <- (t(e)) %*% solve((i-t))
  return(ma)
}

```

